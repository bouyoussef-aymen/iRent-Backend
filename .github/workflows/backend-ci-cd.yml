name: backend-ci-cd

on:
  pull_request:
    paths:
      - "mvp/**"
      - "pom.xml"
  push:
    branches: [feature/pipeline]

env:
  JAVA_VERSION: "25"
  IMAGE_NAME: backend
  REGISTRY: ghcr.io
  AZURE_WEBAPP_NAME: ${{ secrets.AZURE_WEBAPP_NAME }}
  AZURE_RESOURCE_GROUP: ${{ secrets.AZURE_RESOURCE_GROUP }}
  LOG_ANALYTICS_CUSTOMER_ID: ${{ secrets.LOG_ANALYTICS_CUSTOMER_ID }}
  LOG_ANALYTICS_SHARED_KEY: ${{ secrets.LOG_ANALYTICS_SHARED_KEY }}

jobs:
  build-test:
    runs-on: ubuntu-latest
    services:
      mssql:
        image: mcr.microsoft.com/mssql/server:2022-latest
        env:
          MSSQL_SA_PASSWORD: MyP@ssw0rd123!
          ACCEPT_EULA: "Y"
        ports:
          - 1433:1433
        options: >-
          --health-cmd="/opt/mssql-tools/bin/sqlcmd -S localhost -U sa -P MyP@ssw0rd123! -Q 'SELECT 1'"
          --health-interval=10s
          --health-timeout=5s
          --health-retries=5
    steps:
      - uses: actions/checkout@v4

      - name: Set up Java
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: ${{ env.JAVA_VERSION }}

      - name: Maven build and test
        run: mvn -B -ntp -f mvp/pom.xml clean verify -Dspring.profiles.active=ci
        env:
          SPRING_DATASOURCE_URL: jdbc:sqlserver://localhost:1433;databaseName=master;encrypt=false;trustServerCertificate=true
          SPRING_DATASOURCE_USERNAME: sa
          SPRING_DATASOURCE_PASSWORD: MyP@ssw0rd123!

      - name: Upload test reports
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: maven-surefire-reports
          path: mvp/target/surefire-reports

  containerize:
    needs: build-test
    if: github.event_name == 'push' && github.ref == 'refs/heads/feature/pipeline'
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
    steps:
      - uses: actions/checkout@v4

      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build Docker image
        run: |
          docker build -t ${{ env.REGISTRY }}/${{ github.repository_owner }}/${{ env.IMAGE_NAME }}:${{ github.sha }} ./mvp

      - name: Push Docker image to GHCR
        run: |
          docker push ${{ env.REGISTRY }}/${{ github.repository_owner }}/${{ env.IMAGE_NAME }}:${{ github.sha }}

  deploy:
    needs: containerize
    if: github.event_name == 'push' && github.ref == 'refs/heads/feature/pipeline'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Azure login
        uses: azure/login@v2
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      - name: Deploy to Web App
        run: |
          az webapp config container set \
            --name ${{ env.AZURE_WEBAPP_NAME }} \
            --resource-group ${{ env.AZURE_RESOURCE_GROUP }} \
            --docker-custom-image-name ${{ env.REGISTRY }}/${{ github.repository_owner }}/${{ env.IMAGE_NAME }}:${{ github.sha }} \
            --docker-registry-server-url https://${{ env.REGISTRY }} \
            --docker-registry-server-user ${{ github.actor }} \
            --docker-registry-server-password ${{ secrets.GITHUB_TOKEN }}

      - name: Prepare DORA payload (deploy success)
        if: success()
        run: |
          cat > body.json <<'EOF'
          {"service":"backend","event":"deploy","status":"success","commit":"${{ github.sha }}","timestamp":"$(date -Iseconds)"}
          EOF

      - name: Prepare DORA payload (deploy fail)
        if: failure()
        run: |
          cat > body.json <<'EOF'
          {"service":"backend","event":"deploy","status":"fail","commit":"${{ github.sha }}","timestamp":"$(date -Iseconds)"}
          EOF

      - name: Send DORA event to Log Analytics
        if: always()
        env:
          LOG_ANALYTICS_CUSTOMER_ID: ${{ env.LOG_ANALYTICS_CUSTOMER_ID }}
          LOG_ANALYTICS_SHARED_KEY: ${{ env.LOG_ANALYTICS_SHARED_KEY }}
        run: |
          if [ ! -f body.json ]; then
            echo "No body.json found; skipping telemetry."
            exit 0
          fi

          BODY=$(cat body.json)
          CONTENT_LENGTH=$(echo -n "$BODY" | wc -c)
          RFC1123_DATE=$(TZ=GMT date "+%a, %d %b %Y %H:%M:%S GMT")
          STRING_TO_SIGN="POST\n$CONTENT_LENGTH\napplication/json\nx-ms-date:$RFC1123_DATE\n/api/logs"
          DECODED_KEY=$(echo -n "$LOG_ANALYTICS_SHARED_KEY" | base64 -d)
          SIGNATURE=$(printf "$STRING_TO_SIGN" | openssl dgst -binary -sha256 -hmac "$DECODED_KEY" | base64)
          AUTH="SharedKey $LOG_ANALYTICS_CUSTOMER_ID:$SIGNATURE"

          curl -sS -X POST "https://$LOG_ANALYTICS_CUSTOMER_ID.ods.opinsights.azure.com/api/logs?api-version=2016-04-01" \
            -H "Content-Type: application/json" \
            -H "Log-Type: DORAEvents" \
            -H "x-ms-date: $RFC1123_DATE" \
            -H "Authorization: $AUTH" \
            -d "$BODY"
